{
  "AWSTemplateFormatVersion" : "2010-09-09",
  "Description" : "csye6225 cloudformation application stack",

  "Parameters": {

  		"DBName": {
  			"Description": "Database Name",
  			"Type": "String"
  		},
  		"DBUser": {
  			"Description": "Database User",
  			"Type": "String"
  		},
  		"DBPassword": {
  			"Description": "Database Password",
  			"Type": "String"
  		},
  		"bucketName": {
  			"Description": "Bucket name",
  			"Type": "String"
  		},
      "DBEngine": {
        "Description": "DB Engine",
  			"Type": "String"
      },
      "DBAllocatedStorage": {
        "Description": "DB AllocatedStorage",
  			"Type": "String"
      },
      "DBEngineVersion": {
        "Description": "DB EngineVersion",
  			"Type": "String"
      },
      "DBInstanceClass": {
        "Description": "DB InstanceClass",
  			"Type": "String"
      },
      "DBInstanceIdentifier": {
        "Description": "DBInstanceIdentifier",
  			"Type": "String"
      },
      "EC2ImageId":{
        "Description": "EC2 ImageId",
  			"Type": "String"
      },
      "EC2InstanceType":{
        "Description": "EC2 InstanceType",
  			"Type": "String"
      },
      "EbsDeviceName" : {
        "Description": "Ebs DeviceName",
  			"Type": "String"
      },
      "EbsVolumeType" : {
        "Description": "Ebs VolumeType",
  			"Type": "String"
      },
      "EbsVolumeSize" : {
        "Description": "Ebs VolumeSize",
  			"Type": "Number"
      },
      "KeyPairName" : {
        "Description": "Key Pair Name",
  			"Type": "String"
      }
    },


  "Resources" : {
    "NVNDynamoDBTable": {
  		      "Type": "AWS::DynamoDB::Table",
  		      "Properties": {
  			"AttributeDefinitions": [
  			  {
  			    "AttributeName": "Id",
  			    "AttributeType": "S"
  			  }
  			],
  			"KeySchema": [
  			  {
  			    "AttributeName": "Id",
  			    "KeyType": "HASH"
  			  }
  			],
  			"ProvisionedThroughput": {
  			  "ReadCapacityUnits": "5",
  			  "WriteCapacityUnits": "5"
  			},
  			"TableName": "csye6225"
  		      }
		    },
    "NVNCloudS3Bucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "BucketName": { "Ref": "bucketName" }
            }
        },

        "NVNCloudRDSDB": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
              "Engine": { "Ref": "DBEngine"},
              "AllocatedStorage": { "Ref": "DBAllocatedStorage"},
              "EngineVersion": { "Ref": "DBEngineVersion"},
              "DBInstanceClass": { "Ref": "DBInstanceClass"},
              "MultiAZ": "false",
              "DBInstanceIdentifier": { "Ref": "DBInstanceIdentifier"},
              "MasterUsername": { "Ref": "DBUser" },
              "MasterUserPassword": { "Ref": "DBPassword" },
              "PubliclyAccessible": "false",
              "DBName": { "Ref": "DBName" },
              "VPCSecurityGroups": [{ "Fn::ImportValue" : "RDSGroupName" }],
              "DBSubnetGroupName": { "Fn::ImportValue" : "DBSubnetGroupName" }
            },
            "DeletionPolicy": "Snapshot"
          },

    "EC2Instance": {
    			"Type": "AWS::EC2::Instance",
    			"Properties": {
    				"ImageId": { "Ref": "EC2ImageId" },
            "KeyName" : { "Ref": "KeyPairName" },
            "IamInstanceProfile" :{"Fn::ImportValue" : "EC2InstanceProfile"},
    				"InstanceType": { "Ref": "EC2InstanceType" },
            "SecurityGroupIds" : [ { "Fn::ImportValue" : "EC2GroupName"} ],
            "SubnetId" : { "Fn::ImportValue" :"PublicSubnet"},
            "Tags":[{
              "Key": "Name",
              "Value": "NVNCloudEC2"
              }],
            "UserData": {
                      "Fn::Base64": {
                          "Fn::Join": [
                              "",
                              [
                                  "#!/bin/bash -xe \n",
                                  "sudo apt-get update \n",
                                  "sudo apt-get install openjdk-8-jdk -y\n",
                                  "sudo apt-get install ruby -y \n",
                                  "sudo apt-get install wget -y \n",
                                  "sudo apt-get install python -y \n",
                                  "sudo apt-get update \n",
                                  "sudo wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install \n",
                                  "sudo chmod +x ./install \n",
                                  "sudo ./install auto \n",
                                  "sudo service codedeploy-agent start \n",
                                  "sudo apt-get install tomcat8 -y \n",
                                  "sudo echo \"JAVA_OPTS=\\\"\\${JAVA_OPTS} -Dspring.profiles.active=aws\\\"\" >> /etc/default/tomcat8 \n",
                                  "sudo service tomcat8 restart \n"
                              ]
                          ]
                      }
                  },
            "BlockDeviceMappings": [
                 {
                     "DeviceName" : { "Ref": "EbsDeviceName"},
                     "Ebs" : {
                        "VolumeType" : { "Ref": "EbsVolumeType"},
                        "VolumeSize" :{ "Ref": "EbsVolumeSize"},
                        "DeleteOnTermination" : false
                    }
                 }
             ]
          }
        }
      },
      "Outputs": {
        "WebAppS3BucketName": {
          "Description": "Web Application S3 Bucket Name",
          "Value": { "Ref": "NVNCloudS3Bucket"},
          "Export" : { "Name" : "WebAppS3BucketName" }
        },
        "EC2Instance": {
          "Description": "EC2 Instance",
          "Value": { "Ref": "EC2Instance"},
          "Export" : { "Name" : "EC2Instance" }
        }
      }
}
