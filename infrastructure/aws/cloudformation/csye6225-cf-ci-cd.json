
{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"csye6225 cloudformation ci-cd stack",
   "Parameters":{
      "BucketName":{
         "Description":"NVN Code Deploy S3 Bucket Name",
         "Type":"String"
      }
   },
   "Resources":{
      "NVNCodeDeployS3Bucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketName":{
               "Ref":"BucketName"
            }
         }
      },
      "TravisUploadToS3Policy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"Travis-Upload-To-S3-Policy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Resource":{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"BucketName"},"/*"]]},
                     "Action":["s3:PutObject"]
                  }
               ]
            },
            "Users":["Travis"]
         }
      },
      "EC2ServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "EC2ServicePolicy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"EC2-ServicePolicy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"BucketName"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"EC2ServiceRole"
               }
            ]
         }
      },
      "CWLogPolicy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CW-LogPolicy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                    "Effect": "Allow",
                    "Action": [
                      "logs:CreateLogGroup",
                      "logs:CreateLogStream",
                      "logs:PutLogEvents",
                      "logs:DescribeLogStreams"
                      ],
                    "Resource": [
                      "arn:aws:logs:*:*:*"
                      ]
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"EC2ServiceRole"
               }
            ]
         }
      },
      "EC2InstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"EC2ServiceRole"
               }
            ]
         }
      },
      "CodeDeployServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
            ],
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.us-east-1.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "TravisCodeDeployPolicy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"Travis-Code-Deploy-Policy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Resource":[
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":application:",
                                {
                                  "Ref":"CodeDeployApplication"
                                }
                             ]
                          ]
                       }
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Resource":[
                       {
                         "Fn::Join":[
                            "",
                            [
                               "arn:aws:codedeploy:",
                               {
                                  "Ref":"AWS::Region"
                               },
                               ":",
                               {
                                 "Ref":"AWS::AccountId"
                               },
                               ":deploymentgroup:",
                               {
                                 "Ref": "CodeDeployApplication"
                               },
                               "/*"
                            ]
                         ]
                       },
                       {
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:codedeploy:",
                              {
                                 "Ref":"AWS::Region"
                              },
                              ":",
                              {
                                "Ref":"AWS::AccountId"
                              },
                              ":deploymentconfig:CodeDeployDefault.OneAtATime"
                           ]
                        ]
                     },
                     {
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:codedeploy:",
                              {
                                 "Ref":"AWS::Region"
                              },
                              ":",
                              {
                                "Ref":"AWS::AccountId"
                              },
                              ":deploymentconfig:CodeDeployDefault.HalfAtATime"
                           ]
                        ]
                     },
                     {
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:codedeploy:",
                              {
                                 "Ref":"AWS::Region"
                              },
                              ":",
                              {
                                "Ref":"AWS::AccountId"
                              },
                              ":deploymentconfig:CodeDeployDefault.AllAtOnce"
                           ]
                        ]
                     }
                    ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource":[
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":deploymentconfig:CodeDeployDefault.OneAtATime"
                             ]
                          ]
                       },
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":deploymentconfig:CodeDeployDefault.HalfAtATime"
                             ]
                          ]
                       },
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":deploymentconfig:CodeDeployDefault.AllAtOnce"
                             ]
                          ]
                       }
                     ]
                  }
               ]
            },
            "Users":["Travis"]
         }
      },
      "CodeDeployApplication": {
        "Type": "AWS::CodeDeploy::Application",
        "Properties": {
          "ComputePlatform": "Server",
          "ApplicationName": "nvn-codedeploy-app"
        }
      },
      "CodeDeploymentGroup":{
        "Type" : "AWS::CodeDeploy::DeploymentGroup",
        "Properties": {
          "DeploymentGroupName": "NvnCloudDeployGroup",
          "ApplicationName": {"Ref" :"CodeDeployApplication"},
          "DeploymentConfigName" : "CodeDeployDefault.OneAtATime",
          "Ec2TagFilters": [
            {"Key":"EC2Name1","Type":"KEY_AND_VALUE","Value":"NVNCloudEC2-1"},
            {"Key":"EC2Name2","Type":"KEY_AND_VALUE","Value":"NVNCloudEC2-2"},
            {"Key":"EC2Name3","Type":"KEY_AND_VALUE","Value":"NVNCloudEC2-3"},
            {"Key":"EC2Name4","Type":"KEY_AND_VALUE","Value":"NVNCloudEC2-4"},
            {"Key":"EC2Name5","Type":"KEY_AND_VALUE","Value":"NVNCloudEC2-5"},
            {"Key":"EC2Name6","Type":"KEY_AND_VALUE","Value":"NVNCloudEC2-6"},
            {"Key":"EC2Name7","Type":"KEY_AND_VALUE","Value":"NVNCloudEC2-7"}
          ],
          "ServiceRoleArn": { "Fn::GetAtt" : [ "CodeDeployServiceRole", "Arn" ] }
        }
      },
      "LambdaExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties":{
           "AssumeRolePolicyDocument":{
           "Statement":[
             {
                 "Effect": "Allow",
                 "Principal":{
                    "Service":[
                       "lambda.amazonaws.com"
                    ]
                 },
                 "Action": [
                    "sts:AssumeRole"
                 ]
             }
           ]
      },
      "Path":"/"
      }
      },
      "NVNlambdaPolicy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"NVNlambda-Policy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Resource": "*",
                     "Action": [
                     "logs:CreateLogGroup",
                     "logs:CreateLogStream",
                     "logs:PutLogEvents",
                     "ses:SendEmail",
                     "dynamodb:CreateTable",
                     "dynamodb:UpdateTimeToLive",
                     "dynamodb:PutItem",
                     "dynamodb:DeleteItem",
                     "dynamodb:GetItem",
                     "dynamodb:Scan",
                     "dynamodb:Query",
                     "dynamodb:UpdateItem",
                     "dynamodb:UpdateTable",
                     "dynamodb:GetRecords"
                      ]
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"LambdaExecutionRole"
               }
            ]
         }
      },
    "CloudWatchPolicy":{
       "Type":"AWS::IAM::Policy",
       "Properties":{
          "PolicyName":"Cloud-Watch-Policy",
          "PolicyDocument":{
             "Version": "2012-10-17",
             "Statement":[
                {
                   "Effect":"Allow",
                   "Resource": [
                        "arn:aws:logs:*:*:*"
                    ],
                   "Action": [
                        "logs:CreateLogGroup",
                        "logs:CreateLogStream",
                        "logs:PutLogEvents",
                        "logs:DescribeLogStreams"
                    ]
                }
             ]
          },
          "Users":["NVNHuskyCloud"]
       }
    }
   },
   "Outputs": {
     "EC2InstanceProfile": {
       "Description": "EC2 Instance Profile",
       "Value": { "Ref": "EC2InstanceProfile"},
       "Export" : { "Name" : "EC2InstanceProfile" }
     }
   }
}
