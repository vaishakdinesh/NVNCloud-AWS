{
   "AWSTemplateFormatVersion":"2012-10-17",
   "Description":"csye6225 cloudformation ci-cd stack",
   "Parameters":{
      "BucketName":{
         "Description":"NVN Code Deploy S3 Bucket Name",
         "Type":"String"
      }
   },
   "Resources":{
      "NVNCodeDeployS3Bucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketName":{
               "Ref":"BucketName"
            }
         }
      },
      "Travis-Upload-To-S3-Policy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"Travis-Upload-To-S3-Policy",
            "PolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Resource":[
                        "*"
                     ],
                     "Action":[
                        "ec2:Describe*"
                     ]
                  }
               ]
            }
         }
      },
      "CodeDeploy-EC2-S3-InstanceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "CodeDeploy-EC2-S3-InstancePolicy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"CodeDeploy-EC2-S3-InstancePolicy",
            "PolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Resource":{"Fn::Join":["",["arn:aws::s3:::",{"Ref":"BucketName"},"/*"]]}
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"CodeDeploy-EC2-S3-InstanceRole"
               }
            ]
         }
      },
      "CodeDeploy-EC2-S3-InstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"CodeDeploy-EC2-S3-InstanceRole"
               }
            ]
         }
      }
   }
}
