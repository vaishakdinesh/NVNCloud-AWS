{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"csye6225 cloudformation ci-cd stack",
   "Parameters":{
      "BucketName":{
         "Description":"NVN Code Deploy S3 Bucket Name",
         "Type":"String"
      }
   },
   "Resources":{
      "NVNCodeDeployS3Bucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "BucketName":{
               "Ref":"BucketName"
            }
         }
      },
      "TravisUploadToS3Policy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"Travis-Upload-To-S3-Policy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Resource":{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"BucketName"},"/*"]]},
                     "Action":["s3:PutObject"]
                  }
               ]
            },
            "Users":["Travis"]
         }
      },
      "EC2ServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "EC2ServicePolicy":{
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"EC2-ServicePolicy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"BucketName"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"EC2ServiceRole"
               }
            ]
         }
      },
      "EC2InstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/",
            "Roles":[
               {
                  "Ref":"EC2ServiceRole"
               }
            ]
         }
      },
      "CodeDeployServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
            ],
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.us-east-1.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "TravisCodeDeployPolicy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"Travis-Code-Deploy-Policy",
            "PolicyDocument":{
               "Version": "2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Resource":[
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":application:codedeploy-agent"
                             ]
                          ]
                       }
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Resource":[
                        "*"
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codedeploy:GetDeploymentConfig"
                     ],
                     "Resource":[
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":deploymentconfig:CodeDeployDefault.OneAtATime"
                             ]
                          ]
                       },
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":deploymentconfig:CodeDeployDefault.HalfAtATime"
                             ]
                          ]
                       },
                       {
                          "Fn::Join":[
                             "",
                             [
                                "arn:aws:codedeploy:",
                                {
                                   "Ref":"AWS::Region"
                                },
                                ":",
                                {
                                  "Ref":"AWS::AccountId"
                                },
                                ":deploymentconfig:CodeDeployDefault.AllAtOnce"
                             ]
                          ]
                       }
                     ]
                  }
               ]
            }
         }
      },
      "CodeDeployApplication": {
        "Type": "AWS::CodeDeploy::Application",
        "Properties": {
          "ComputePlatform": "Server"
        }
      },
      "CodeDeploymentConfig":{
        "Type" : "AWS::CodeDeploy::DeploymentConfig",
          "Properties" : {
            "DeploymentConfigName" : "NVNCloudDeploy",
            "MinimumHealthyHosts" : {
              "Type" : "FLEET_PERCENT",
              "Value" : "75"
            }
          }
      },
      "CodeDeploymentGroup":{
        "Type" : "AWS::CodeDeploy::DeploymentGroup",
        "Properties": {
          "ApplicationName": {"Ref" :"CodeDeployApplication"},
          "DeploymentConfigName" :{"Ref" :"CodeDeploymentConfig"},
          "Ec2TagFilters": [{"Key":"aws:cloudformation:logical-id","Type":"KEY_AND_VALUE","Value":"EC2Instance"}],
          "ServiceRoleArn": { "Fn::GetAtt" : [ "CodeDeployServiceRole", "Arn" ] }
        }
      }
   },
   "Outputs": {
     "EC2InstanceProfile": {
       "Description": "EC2 Instance Profile",
       "Value": { "Ref": "EC2InstanceProfile"},
       "Export" : { "Name" : "EC2InstanceProfile" }
     }
   }
}
